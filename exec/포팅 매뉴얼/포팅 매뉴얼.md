# ê°œë°œ í™˜ê²½

| JVM | Java 17 |
| --- | --- |
| WAS | Spring Boot 3.2.5 |
| Build Tool | Gradle 8.7 |
| IDE | Intellij 2023.3.2 |

# Infra

## ìµœì¢… ì½”ë“œ

- `application.yaml`
    
    ```yaml
    server:
      port: 8081
      url: http://localhost:8081
      description: Local Server
    
    spring:
      datasource:
        url: jdbc:mysql://localhost:3306/relicking?serverTimezone=Asia/Seoul
        username: seveneleven
        password:
        driver-class-name: com.mysql.cj.jdbc.Driver
      jpa:
        hibernate:
          ddl-auto: update
        show-sql: true
        properties:
          hibernate:
            format_sql: true
            default_batch_fetch_size: 1000
      jwt:
        secret:
      mail:
        host: smtp.gmail.com
        port: 587
        username:
        password:
        properties:
          mail:
            smtp:
              auth: true
              starttls:
                enable: true
                required: true
              connectiontimeout: 5000  # í´ë¼ì´ì–¸íŠ¸ê°€ SMTP ì„œë²„ì™€ì˜ ì—°ê²°ì„ ì„¤ì •í•˜ëŠ”ë° ëŒ€ê¸°í•´ì•¼ í•˜ëŠ” ì‹œê°„
              timeout: 5000  # í´ë¼ì´ì–¸íŠ¸ê°€ SMTP ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ëŒ€ê¸°í•´ì•¼ í•˜ëŠ” ì‹œê°„. ì„œë²„ì—ì„œ ì‘ë‹µì´ ì˜¤ì§€ ì•ŠëŠ” ê²½ìš° ëŒ€ê¸° ì‹œê°„ì„ ì œí•œí•˜ê¸° ìœ„í•´ ì‚¬ìš©.
              writetimeout: 5000  # í´ë¼ì´ì–¸íŠ¸ê°€ ì‘ì—…ì„ ì™„ë£Œí•˜ëŠ”ë° ëŒ€ê¸°í•´ì•¼ í•˜ëŠ” ì‹œê°„. ì´ë©”ì¼ì„ SMTP ì„œë²„ë¡œ ì „ì†¡í•˜ëŠ”ë° ê±¸ë¦¬ëŠ” ì‹œê°„ì„ ì œí•œí•˜ëŠ”ë° ì‚¬ìš©.
        auth-code-expiration-millis: 600000  # ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ ë§Œë£Œ ì‹œê°„ 10ë¶„
      data:
        redis:
          port: 6379
          host: localhost
          password:
    
    logging:
      level:
        sql: info
    
    springdoc:
      api-docs:
        path: /api/docs
      default-consumes-media-type: application/json
      default-produces-media-type: application/json
      show-login-endpoint: true
      swagger-ui:
        path: /api/swagger-ui
        operations-sorter: alpha
        tags-sorter: alpha
        disable-swagger-default-url: true
        display-query-params-without-oauth2: true
        doc-expansion: none
      paths-to-match:
        - /**
    
    ```
    
- `docker-compose.yml`
    - **docker compose v2.25.0** ì´ìƒ ë²„ì „ë¶€í„°ëŠ” `version : '3'`ì´ í•„ìš” ì—†ë‹¤!
    - ë“¤ì—¬ì“°ê¸°ë¥¼ tabìœ¼ë¡œ í•˜ë©´ ì•ˆ ë˜ê³  ìŠ¤í˜ì´ìŠ¤ë°” 2ë²ˆìœ¼ë¡œ í•´ì•¼ í•œë‹¤!
        - vië¡œ íŒŒì¼ì„ ì—´ê³  `:set list`í•˜ë©´ íƒ­ì¸ì§€ ìŠ¤í˜ì´ìŠ¤ë°”ì¸ì§€ ë³´ì¸ë‹¤.
    
    ```yaml
    services:
      jenkins:
        image: jenkins/jenkins:jdk17
        container_name: jenkins
        ports:
          - "8080:8080"
        user: root
        volumes:
          - /home/ubuntu/jenkins-data:/var/jenkins_home
    
      nginx:
        image: nginx
        container_name: nginx
        ports:
          - "80:80"
          - "443:443"
        environment:
          TZ: Asia/Seoul
        volumes:
          - /etc/nginx:/etc/nginx
        restart: always
    
      mysql:
        image: mysql
        container_name: mysql
        ports:
          - "3306:3306"
        environment:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: relicking
          MYSQL_USER: seveneleven
          MYSQL_PASSWORD:
          TZ: Asia/Seoul
        volumes:
          - /home/ubuntu/mysql/data:/var/lib/mysql
          - /home/ubuntu/mysql/config:/etc/mysql/conf.d
          - /home/ubuntu/mysql/init:/docker-entrypoint-initdb.d
    
      redis:
        image: redis:7.2-alpine
        container_name: redis
        ports:
          - "6379:6379"
        command: redis-server /usr/local/etc/redis/redis.conf
        environment:
          TZ: Asia/Seoul
        volumes:
          - /home/ubuntu/redis/data:/data
          - /home/ubuntu/redis/conf/redis.conf:/usr/local/etc/redis/redis.conf
    
      spring:
        build:
          context: ./jenkins-data/workspace/relicking/backend/RelicKing
        container_name: spring
        environment:
          TZ: Asia/Seoul
        # ports:
        #   - "8081:8081"
    
      sonarqube:
        image: sonarqube:community
        hostname: sonarqube
        container_name: sonarqube
        depends_on:
          sonarqube_db:
            condition: service_healthy
        environment:
          SONAR_JDBC_URL: jdbc:postgresql://sonarqube_db:5432/sonar
          SONAR_JDBC_USERNAME: sonar
          SONAR_JDBC_PASSWORD: sonar
        volumes:
          - /home/ubuntu/sonarqube/data:/opt/sonarqube/data
          - /home/ubuntu/sonarqube/extensions:/opt/sonarqube/extensions
          - /home/ubuntu/sonarqube/logs:/opt/sonarqube/logs
        ports:
          - "9000:9000"
      
      sonarqube_db:
        image: postgres:15
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U sonar"]
          interval: 10s
          timeout: 5s
          retries: 5
        hostname: postgresql
        container_name: sonarqube_db
        environment:
          POSTGRES_USER: sonar
          POSTGRES_PASSWORD: sonar
          POSTGRES_DB: sonar
        volumes:
          - /home/ubuntu/postgresql:/var/lib/postgresql
          - /home/ubuntu/postgresql/data:/var/lib/postgresql/data
    ```
    
- `jenkins pipeline`
    
    ```bash
    pipeline {
        agent any
        
        tools {
            gradle "gradle_8.7"
        }
        
        stages {
            stage('Clone Repository') {
                steps {
                    echo '---------- Clone Repository ----------'
                    script {
                        git branch: 'be-develop',
                        credentialsId: 'inhwa_gitlab_username_password',
                        url: 'https://lab.ssafy.com/s10-final/S10P31D211.git'
                    }
                }
                post {
                    failure {
                        mattermostSend color: "danger", message: ":jenkins6:  [BE] Clone Repository ì‹¤íŒ¨.. - [Jenkins #${env.BUILD_NUMBER}](${env.BUILD_URL})"
                    }
                }
            }
            
            stage('Copy application.yml') {
                steps {
                    echo '---------- Copy application.yml ----------'
                    withCredentials([file(credentialsId: 'application_yml', variable: 'appication_yml')]) {
                        script {
                            sh 'cp $appication_yml ./backend/RelicKing/src/main/resources/application.yml'
                        }
                    }
                }
                post {
                    failure {
                        mattermostSend color: "danger", message: ":jenkins6:  [BE] Copy application.yml ì‹¤íŒ¨.. - [Jenkins #${env.BUILD_NUMBER}](${env.BUILD_URL})"
                    }
                }
            }
            
            stage('SonarQube Analysis') {
                steps {
                    echo '---------- SonarQube Analysis ----------'
                    withSonarQubeEnv('sonarqube_server') {
                        dir("backend/RelicKing") {
                            sh 'chmod +x ./gradlew; ./gradlew sonar'
                        }
                    }
                }
                post {
                    failure {
                        mattermostSend color: "danger", message: ":jenkins6:  [BE] SonarQube Analysis ì‹¤íŒ¨.. - [Jenkins #${env.BUILD_NUMBER}](${env.BUILD_URL})"
                    }
                }
            }
            
            stage('Build') {
                steps {
                    dir("backend/RelicKing") {
                        echo '---------- Build ----------'
                        sh 'chmod +x ./gradlew; ./gradlew bootJar'
                    }
                }
                post {
                    failure {
                        mattermostSend color: "danger", message: ":jenkins6:  [BE] Build ì‹¤íŒ¨.. - [Jenkins #${env.BUILD_NUMBER}](${env.BUILD_URL})"
                    }
                }
            }
            
            stage('Deploy') {
                steps {
                    echo '---------- Deploy ----------'
                    sshagent(['k10d211.p.ssafy.io']) {
                        sh 'ssh ubuntu@k10d211.p.ssafy.io "sh ~/spring/deploy.sh"'
                    }
                }
                post {
                    failure {
                        mattermostSend color: "danger", message: ":jenkins6:  [BE] Deploy ì‹¤íŒ¨.. - [Jenkins #${env.BUILD_NUMBER}](${env.BUILD_URL})"
                    }
                }
            }
        }
        
        post {
            success {
                mattermostSend color: "good", message: ":jenkins_cute_flip:  [BE] ë°°í¬ ì„±ê³µ!! - [Jenkins #${env.BUILD_NUMBER}](${env.BUILD_URL})"
            }
        }
    }
    ```
    

---

## GitLabì— pushí•˜ë©´ MatterMostë¡œ ì•Œë¦¼ ë³´ë‚´ê¸°

1. MatterMost ì±„ë„ ìƒì„±
    
    ![Untitled](assets/Untitled.png)
    
2. MatterMost Channels > í†µí•©
    
    ![Untitled](assets/Untitled%201.png)
    
    ì „ì²´ Incoming Webhook > Incoming Webhook ì¶”ê°€í•˜ê¸°
    
3. ë‚´ìš© ì…ë ¥
    
    ì œëª©, ì„¤ëª…ì€ ì•„ë¬´ë ‡ê²Œë‚˜ ì„¤ì •
    
    ![Untitled](assets/Untitled%202.png)
    
    ì €ì¥
    
4. ì„¤ì •ëœ ì›¹í›… URL í™•ì¸
5. ì•Œë¦¼ì„ ë°›ì„ branchë¥¼ protectedë¡œ ì„¤ì •í•˜ê¸°
    
    Gitlab Project > Settings > Repository > Protected branches 
    
    ![Untitled](assets/Untitled%203.png)
    
6. GitLab Project > Settings > Integrations > Mattermost notifications Configure
    
    ![Untitled](assets/Untitled%204.png)
    
7. ì ì ˆíˆ ì²´í¬
    
    Webhook : 4ë²ˆì—ì„œ í™•ì¸í•œ URL ê¸°ì…
    
    ![Untitled](assets/Untitled%205.png)
    
    ![Untitled](assets/Untitled%206.png)
    
    Save changes
    

## EC2

`K10D211T.pem` íŒŒì¼ì´ ìœ„ì¹˜í•œ ê³³ì—ì„œ Bash ì‹¤í–‰

```bash
ssh -i K10D211T.pem ubuntu@k10d211.p.ssafy.io
```

SSHë¥¼ ì‚¬ìš©í•˜ì—¬

`K10D211.pem`ë¼ëŠ” ê°œì¸ í‚¤ íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬

`ubuntu` ì‚¬ìš©ìë¡œ

`k10d211.p.ssafy.io` í˜¸ìŠ¤íŠ¸ì— ì—°ê²°

### EC2 ì„¤ì •

ì„œë²„ ì‹œê°„ ì„¤ì •

```bash
sudo timedatectl set-timezone Asia/Seoul
timedatectl  # í™•ì¸
```

![Untitled](assets/Untitled%207.png)

## Docker

### Docker ì„¤ì¹˜

[Install Docker Engine on Ubuntu](https://docs.docker.com/engine/install/ubuntu/)

1. Uninstall old versions
    
    ```bash
    for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do sudo apt-get remove $pkg; done
    ```
    
2. Set up Docker'sÂ `apt`Â repository.
    
    ```bash
    # Add Docker's official GPG key:
    sudo apt-get update
    sudo apt-get install ca-certificates curl
    sudo install -m 0755 -d /etc/apt/keyrings
    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    sudo chmod a+r /etc/apt/keyrings/docker.asc
    
    # Add the repository to Apt sources:
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    sudo apt-get update
    ```
    
3. Install the Docker packages.
    
    ```bash
    sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    ```
    
4. Verify that the Docker Engine installation is successful.
    
    ```bash
    docker --version
    docker compose version
    ```
    
    ![Untitled](assets/Untitled%208.png)
    
    ![Untitled](assets/Untitled%209.png)
    

### sudo ì—†ì´ docker ëª…ë ¹ì–´ ì‹¤í–‰í•˜ê¸°

[[Docker] ë„ì»¤ sudo ì—†ì´ ëª…ë ¹ì–´ ì‚¬ìš©í•˜ê¸°](https://jkim83.tistory.com/167)

1. docker ê·¸ë£¹ ìƒì„±
    
    ```bash
    sudo groupadd docker
    ```
    
2. docker ê·¸ë£¹ì— `ubuntu`ë¼ëŠ” ì‚¬ìš©ì ì¶”ê°€
    
    ```bash
    sudo usermod -aG docker ubuntu
    ```
    
3. ì‹œìŠ¤í…œ ì¬ë¶€íŒ…í•˜ê¸°
    
    ```bash
    $ sudo systemctl reboot
    ```
    
4. sudo ì—†ì´ docker ëª…ë ¹ì–´ ì‹¤í–‰í•´ë³´ê¸°
    
    ```bash
    docker ps
    ```
    
    ![Untitled](assets/Untitled%2010.png)
    

## Jenkins

### Jenkins ì„¤ì¹˜

1. TCP í¬íŠ¸ 8080 í—ˆìš©
    
    ```bash
    sudo ufw allow 8080/tcp
    sudo ufw reload
    sudo ufw status  # í™•ì¸
    ```
    
2. volume ì €ì¥í•  ë””ë ‰í† ë¦¬ ìƒì„±
    
    (ì•ˆ ë§Œë“¤ì–´ë†”ë„ ë˜ê¸´ í•˜ëŠ”ë“¯)
    
    ```bash
    cd /home/ubuntu
    mkdir jenkins-data
    ```
    
3. `docker-compose.yml` ìƒì„±
    
    `~` ë””ë ‰í† ë¦¬ì— ìœ„ì¹˜ì‹œì¼°ë‹¤.
    
    ```yaml
    services:
      jenkins:
        image: jenkins/jenkins:jdk17
        container_name: jenkins
        ports:
          - "8080:8080"
        user: root
        volumes:
          - /home/ubuntu/jenkins-data:/var/jenkins_home
    ```
    
    ì•„ë˜ ëª…ë ¹ì–´ë¥¼ docker-composeë¡œ ë³€í™˜í•œ ê²ƒì´ë‹¤.
    
    ```bash
    docker run -d \
      --name jenkins \
      -p 8080:8080 \
      -v /home/ubuntu/jenkins-data:/var/jenkins_home \
      --user root \
      jenkins/jenkins:jdk17
    ```
    
4. docker compose ì‹¤í–‰
    
    `docker-compose.yml`ì´ ìœ„ì¹˜í•œ `~` ë””ë ‰í† ë¦¬ì—ì„œ ëª…ë ¹ì–´ ì‹¤í–‰
    
    ```bash
    sudo docker compose up
    ```
    
    `-d` ì˜µì…˜ì„ ë„£ìœ¼ë©´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ëœë‹¤.
    
5. bashì—ì„œ jenkins ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    
    ![Untitled](assets/Untitled%2011.png)
    
6. docker container ì¢…ë£Œ ë° ìƒíƒœ í™•ì¸
    
    ```bash
    docker ps -a
    ```
    
    ![Untitled](assets/Untitled%2012.png)
    

### Jenkins ì´ˆê¸° ì„¤ì •

1. jenkins ì ‘ì† [http://k10d211.p.ssafy.io:8080](http://k10d211.p.ssafy.io:8080/)
2. [ìœ„ì—ì„œ í™•ì¸](https://www.notion.so/CI-CD-8ab377b9a8c847f7ab1db923a768b51c?pvs=21)í•œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
3. Install suggested plugins
    
    ê¸°ë³¸ ì¶”ì²œ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ (ì‹œê°„ ì¢€ ê±¸ë¦°ë‹¤.)
    
    ![Untitled](assets/Untitled%2013.png)
    
4. admin ì‚¬ìš©ì ìƒì„±
    
    ![Untitled](assets/Untitled%2014.png)
    
5. ì™¸ë¶€ ì ‘ì† URL ì„¤ì •
    
    ![Untitled](assets/Untitled%2015.png)
    

## Nginx

### Nginx ì„¤ì¹˜

[NGINX Docker container ë§Œë“¤ê¸°](https://velog.io/@woo94/NGINX-Docker-container-ë§Œë“¤ê¸°)

> **Q. nginxë¥¼ ì´ˆê¸°ì— ì„ì‹œë¡œ ë„ìš°ëŠ” ì´ìœ ?**
<br>
A. ì„ì˜ë¡œ ë§Œë“  nginxì—ì„œ ì„¤ì •íŒŒì¼ë§Œ ê°€ì ¸ì˜¤ê³  ì‹¶ê¸° ë•Œë¬¸!

1. ì„ì‹œ nginx container ë„ìš°ê¸°
    
    ```bash
    docker run -d --name tmp-nginx nginx
    ```
    
2. tmp-nginx containerì˜ `/etc/nginx` ë””ë ‰í† ë¦¬ë¥¼ Host PC(EC2)ì˜ `/etc`ë¡œ ë³µì‚¬
    
    ```bash
    sudo docker cp tmp-nginx:/etc/nginx /etc
    ```
    
3. container ì‚­ì œ
    
    ```bash
    docker stop tmp-nginx
    docker rm tmp-nginx
    ```
    
4. `docker-compose.yml` ìˆ˜ì •
    
    ```yaml
    services:
      
      ...
    
      nginx:
        image: nginx
        container_name: nginx
        ports:
          - "80:80"
          - "443:443"
        environment:
          TZ: Asia/Seoul
        volumes:
          - /etc/nginx:/etc/nginx
        restart: always
    ```
    
5. docker êµ¬ë™
    
    ```bash
    sudo docker compose up -d
    ```
    
6. í™•ì¸
    
    ![Untitled](assets/Untitled%2016.png)
    

### SSLì´ë€

> Secure Socket Layer

ì„œë²„ì™€ ì‚¬ìš©ì ê°„ì— í†µì‹ ì„ í•  ê²½ìš° ì •ë³´ë¥¼ ì•”í˜¸í™”í•˜ê³  ë„ì¤‘ì— í•´í‚¹ìœ¼ë¡œ ì¸í•´ ì •ë³´ê°€ ìœ ì¶œëœë‹¤ê³  í•´ë„ ì •ë³´ì˜ ë‚´ìš©ì„ ë³´í˜¸í•  ìˆ˜ ìˆëŠ” ë³´ì•ˆ ì¸ì¦ ì†”ë£¨ì…˜ ê¸°ìˆ .

í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ì–‘ë‹¨ ê°„ **ì‘ìš©ê³„ì¸µ(7)** ë° **TCP ì „ì†¡ê³„ì¸µ(4)** ì‚¬ì´ì—ì„œ ì•ˆì „í•œ ë³´ì•ˆ ì±„ë„ì„ í˜•ì„±í•´ì£¼ëŠ” ì—­í• ì„ í•˜ëŠ” ë³´ì•ˆìš© í”„ë¡œí† ì½œì´ë‹¤. SSLê³¼ TLSëŠ” ë²„ì „ì˜ ì°¨ì´ì´ë©°, ë³´í†µ SSLì´ë¼ í†µì¹­í•œë‹¤.

ì‚¬ìš© í¬íŠ¸ : HTTPSì˜ ê²½ìš°, HTTPë¥¼ ìœ„í•œ SSL/TLS ë³´ì•ˆ í„°ë„ í˜•ì„±ì„ ìœ„í•´ `443` ì‚¬ìš©

**HTTPS(HyperText Transfer Protocol over SSL)**

> SSL ìœ„ì— SSLì„ ì ìš©í•œ HTTPë¡œ **ë³´ì•ˆì„ ê°•í™”**í•œ ì „ì†¡ ê¸°ëŠ¥ì´ë‹¤. ê·¸ë˜ì„œ **SSL ì¸ì¦ì„œ ì ìš©**ì´ ëœ ë„ë©”ì¸ë§Œì´ **`https://`** ì£¼ì†Œë¥¼ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.

![Untitled](assets/Untitled%2017.png)

SSL For Freeë¥¼ í†µí•´ SSLì„ ë¬´ë£Œë¡œ ë°œê¸‰ë°›ì•„ë³´ì!

### SSL ë°œê¸‰

[SSL ë³´ì•ˆ ì¸ì¦ì„œ ë¬´ë£Œ ë°œê¸‰ ë°›ê¸° [SSL For Free]](https://foxydog.tistory.com/39)

1. ì‚¬ì´íŠ¸ ì ‘ì†
    
    [SSL For Free - Free SSL Certificates in Minutes](https://www.sslforfree.com/)
    
2. ë°œê¸‰ë°›ì„ ë„ë©”ì¸ ì…ë ¥
    
    ![Untitled](assets/Untitled%2018.png)
    
3. ë¬´ë£Œ ê³„ì • ê°€ì…
    
    ![Untitled](assets/Untitled%2019.png)
    
4. ì¸ì¦ì„œ ì‹ ì²­
    
    ![Untitled](assets/Untitled%2020.png)
    
    ![Untitled](assets/Untitled%2021.png)
    
    ![Untitled](assets/Untitled%2022.png)
    
5. ë„ë©”ì¸ ì†Œìœ ê¶Œ í™•ì¸í•˜ê¸°
    
    HTTP File Upload ë°©ì‹ ì„ íƒ
    
    ![Untitled](assets/Untitled%2023.png)
    
    nginx bash ì ‘ì†
    
    ```bash
    docker exec -it nginx bash
    ```
    
    ê²½ë¡œ ì´ë™ (nginxì˜ ê¸°ë³¸ ê²½ë¡œëŠ” `/usr/share/nginx/html`ì´ë‹¤.)
    
    ```bash
    cd /usr/share/nginx/html
    mkdir .well-known
    cd .well-known
    mkdir pki-validation
    cd pki-validation
    ```
    
    vim ì„¤ì¹˜
    
    ```bash
    apt-get update
    apt-get install vim
    ```
    
    íŒŒì¼ ì‘ì„±
    
    ```bash
    vim 0EBCD8EBE6B1234BA5AAA8BFB3A11385.txt
    ```
    
    ```bash
    BA3E03681B3E369336B24CEEC2175B56D22F2F0F4FCCC81642063AA8F9316373
    comodoca.com
    78311b76abb6ad0
    ```
    
    ë§í¬ í´ë¦­í•˜ì—¬ ì œëŒ€ë¡œ ëœ¨ëŠ”ì§€ í™•ì¸
    
    ![Untitled](assets/Untitled%2024.png)
    
6. Verify Domain
7. Download Certificate
    
    Server Type : NGINX
    

### SSL ì ìš©

[[Nginx] SSL ì ìš©í•˜ê¸°](https://velog.io/@coastby/Nginx-SSL-ì ìš©í•˜ê¸°)

[ZeroSSL Help-Center](https://help.zerossl.com/hc/en-us/articles/360058295894-Installing-SSL-Certificate-on-NGINX)

1. ë‹¤ìš´ë°›ì€ íŒŒì¼ì„ ì••ì¶• í•´ì œí•˜ê³  í•´ë‹¹ í´ë”ë¥¼ FileZillaë¥¼ í†µí•´ EC2ì˜ `~` ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
2. Merge `.crt` Files
    
    ```bash
    cd k10d211.p.ssafy.io/
    cat certificate.crt ca_bundle.crt >> certificate.crt
    ```
    
    ![Untitled](assets/Untitled%2025.png)
    
3. í•´ë‹¹ í´ë”ë¥¼ `/etc/nginx`ë¡œ ë³µì‚¬í•˜ê³  ì›ë³¸ ì‚­ì œ
    
    í•´ë‹¹ í´ë”ì˜ íŒŒì¼ë“¤ì€ ì„œë²„ê°€ êº¼ì¡Œë‹¤ ì¼œì ¸ë„ ë‚¨ì•„ìˆì–´ì•¼ í•œë‹¤!
    
    ê·¸ëŸ¬ë¯€ë¡œ docker volume ì„¤ì • ë˜ì–´ìˆëŠ” ë””ë ‰í† ë¦¬ë¡œ ì˜®ê¸°ëŠ” ê²ƒì´ë‹¤.
    
    ```bash
    cd ~
    sudo cp -r k10d211.p.ssafy.io/ /etc/nginx/
    rm -rf k10d211.p.ssafy.io/
    ```
    
4. `default.conf` íŒŒì¼ ìˆ˜ì •
    
    ```bash
    sudo vim /etc/nginx/conf.d/default.conf
    ```
    
    ```bash
    server {
        listen       80;
        listen  [::]:80;
        server_name  k10d211.p.ssafy.io;
    
        if ($host = k10d211.p.ssafy.io) {
            return 301 https://$host$request_uri;
        }
    
        return 404;
    }
    
    server {
        listen 443 ssl;
        server_name k10d211.p.ssafy.io;
    
        ssl_certificate         /etc/nginx/k10d211.p.ssafy.io/certificate.crt;
        ssl_certificate_key     /etc/nginx/k10d211.p.ssafy.io/private.key;
        
        location / {
            root   /usr/share/nginx/html;
            index  index.html index.htm;
        }
    
        location /api {
            proxy_pass http://192.168.160.5:8081/api;
        }
    
        error_page   404  /404.html;
        location = /40x.html {
            root   /usr/share/nginx/html;
        }
    
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }
    ```
    
    â€» spring containerì˜ Private IP Address ì¡°íšŒí•˜ëŠ” ë²•
    
    - hostPCì—ì„œ ì•„ë˜ ëª…ë ¹ì–´ ì‹¤í–‰
        
        ```bash
        docker inspect spring
        ```
        
        `NetworkSettings.Networks.ubuntu_default.IPAddress` í•­ëª© í™•ì¸ : `192.168.128.6`
        
5. `nginx` containerì˜ bashë¡œ ì§„ì…í•˜ì—¬ ì„œë²„ ì¬ì‹œì‘
    
    ```bash
    docker exec -it nginx bash
    /etc/init.d/nginx restart
    ```
    
6. í™•ì¸
    
    ![Untitled](assets/Untitled%2026.png)
    

## MySQL

### MySQL ì„¤ì¹˜ ë° í™•ì¸

1. docker ì¤‘ì§€
    
    ```bash
    docker compose down
    ```
    
2. `docker-compose.yml` ìˆ˜ì •
    
    ```bash
    vi docker-compose.yml
    ```
    
    ```yaml
    services:
    
      ...
    
      mysql:
        image: mysql
        container_name: mysql
        ports:
          - "3306:3306"
        environment:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: relicking
          MYSQL_USER: seveneleven
          MYSQL_PASSWORD: tpqmsdlffpqms!
          TZ: Asia/Seoul
        volumes:
          - /home/ubuntu/mysql/data:/var/lib/mysql
          - /home/ubuntu/mysql/config:/etc/mysql/conf.d
          - /home/ubuntu/mysql/init:/docker-entrypoint-initdb.d
    ```
        
3. docker ì¬êµ¬ë™
    
    ```bash
    sudo docker compose up -d
    ```
    

**CLIë¡œ ì ‘ì†í•´ë³´ê¸°!**

1. mysql container ì ‘ì†
    
    ```bash
    docker exec -it mysql /bin/bash
    ```
    
2. `seveneleven` ê³„ì •ìœ¼ë¡œ mysql ì ‘ì†
    
    ```bash
    mysql -u seveneleven -p
    ```
    
3. mysql ì ‘ì† ì„±ê³µ!
    
    ![Untitled](assets/Untitled%2027.png)
    
4. ê¶Œí•œ í™•ì¸
    
    ```sql
    SHOW GRANTS FOR CURRENT_USER;
    ```
    
    ![Untitled](assets/Untitled%2028.png)
    
    `seveneleven` ì‚¬ìš©ìì˜ ê¶Œí•œì— ëŒ€í•´ ë‹¤ìŒ 2ê°€ì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
    
    1. ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•œ ì‚¬ìš© ê¶Œí•œ(`USAGE`)ì„ ê°€ì§€ê³  ìˆìŒ
    2. `relicking` ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•´ì„œëŠ” ëª¨ë“  ê¶Œí•œ(`ALL PRIVILEGES`)ì„ ê°€ì§€ê³  ìˆìŒ
    
    ì´ë“¤ ê¶Œí•œì€ `docker-compose.yml`ì— ëª…ì‹œí–ˆê¸° ë•Œë¬¸ì— ì£¼ì–´ì§„ ê²ƒì´ë‹¤!
    

## Redis

### Redis ì„¤ì¹˜

1. `docker-compose.yml` ìˆ˜ì •
    
    ```yaml
    services:
      
      ...
    
      redis:
        image: redis:7.2-alpine
        container_name: redis
        ports:
          - "6379:6379"
        command: redis-server /usr/local/etc/redis/redis.conf
        environment:
          TZ: Asia/Seoul
        volumes:
          - /home/ubuntu/redis/data:/data
          - /home/ubuntu/redis/conf/redis.conf:/usr/local/etc/redis/redis.conf
    ```
    
2. `redis/conf/redis.conf` íŒŒì¼ ì‘ì„±
    
    ```bash
    mkdir redis
    cd redis
    mkdir conf
    cd conf
    touch redis.conf
    vi redis.conf
    ```
    
    [Redis configuration](https://redis.io/docs/latest/operate/oss_and_stack/management/config/)
    
    ìœ„ ë§í¬ì—ì„œ ë²„ì „(7.2)ì— ë§ì€ íŒŒì¼ ë‚´ìš© ë³µì‚¬í•´ì„œ `redis.conf`ì— ë¶™ì—¬ë„£ê¸°
    
3. redis êµ¬ë™
    
    ```bash
    sudo docker compose up redis -d
    ```
    

## Spring ë°°í¬

[SpringBoot, Vue3 í”„ë¡œì íŠ¸ CI/CD (2)](https://gunjoon.tistory.com/199)

### GitLab í† í° ë°œê¸‰

GitLab User settings > Access Tokens > Add new token

![Untitled](assets/Untitled%2029.png)

### GitLab â†” Jenkins ì—°ë™

1. Jenkins ê´€ë¦¬ > Credentials > (global) > Add Credentials
    
    ![Untitled](assets/Untitled%2030.png)
    
2. Jenkins ê´€ë¦¬ > System > GitLab
    
    ![Untitled](assets/Untitled%2031.png)
    
    Test Connection í•´ë³´ê¸°
    

### Jenkins JDK, Gradle ì„¤ì •

Jenkins ê´€ë¦¬ > Tools

1. JDK installations > Add JDK
    
    ![Untitled](assets/Untitled%2032.png)
    
2. Gradle installations > Add Gradle
    
    ìŠ¤í”„ë§ í”„ë¡œì íŠ¸ì—ì„œ Gradle ë²„ì „ í™•ì¸
    
    - `backend/RelicKing/gradle/wrapper/gradle-wrapper.properties`
    
    ```
    distributionBase=GRADLE_USER_HOME
    distributionPath=wrapper/dists
    distributionUrl=https\://services.gradle.org/distributions/gradle-8.7-bin.zip
    networkTimeout=10000
    validateDistributionUrl=true
    zipStoreBase=GRADLE_USER_HOME
    zipStorePath=wrapper/dists
    ```
    
    ![Untitled](assets/Untitled%2033.png)
    
    Install automatically ì²´í¬í•œ ê²ƒì€ íŒŒì´í”„ë¼ì¸ì´ ì‹¤í–‰ë  ë•Œ ì„¤ì¹˜ëœë‹¤.
    
3. Save

### Item ì¶”ê°€

1. Jenkins ìƒˆë¡œìš´ Item
    
    item name : relicking
    
    item type : Pipeline
    
2. Build Triggers ì„¤ì •
    
    webhook URL ê¸°ì–µí•´ë‘ê¸°!
    
    ![Untitled](assets/Untitled%2034.png)
    
    ê³ ê¸‰ > Secret token > Generate
    

### `application.yml` ì—…ë¡œë“œ

Jenkins ê´€ë¦¬ > (global) > Add Credentials

![Untitled](assets/Untitled%2035.png)

### ë°°í¬ ì¤€ë¹„ - spring

1. spring í”„ë¡œì íŠ¸ root ê²½ë¡œì— `Dockerfile` ì¶”ê°€
    
    ```docker
    FROM openjdk:17
    
    COPY ./build/libs/*.jar app.jar
    
    CMD ["java", "-jar", "app.jar"]
    ```
    
2. `docker-compose.yml` ìˆ˜ì •
    
    ```yaml
    services:
      
      ...
    
      spring:
        build:
          context: ./jenkins-data/workspace/relicking/backend/RelicKing
        container_name: spring
        environment:
          TZ: Asia/Seoul
        ports:
          - "8081:8081"
    ```
    
    `context`
    
    - `Dockerfile`ì˜ ëª…ì‹œ
3. ì‹¤í–‰ íŒŒì¼ ìƒì„± - `/home/ubuntu/spring/deploy.sh` ì‘ì„±
    
    ```bash
    mkdir spring
    cd spring
    vi deploy.sh
    ```
    
    ```bash
    docker compose down spring
    docker system prune -a -f
    docker compose up spring -d
    ```
    

### ë°°í¬ ì¤€ë¹„ - SSH Agent

[[Jenkins] SSH ì‚¬ìš© - pipeline SSH Agent](https://royleej9.tistory.com/entry/Jenkins-SSH-ì‚¬ìš©-pipeline-SSH-Agent)

1. Jenkinsì— `SSH Agent` í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
2. pem í‚¤ ë‚´ìš© ë³µì‚¬
3. SSH ì¸ì¦ ì •ë³´ ë“±ë¡
    
    Jenkins ê´€ë¦¬ > Credentials > (global) > Add Credentials
    
    Keyì— 2ë²ˆì—ì„œ ë³µì‚¬í•´ë’€ë˜ pem í‚¤ì˜ ë‚´ìš© ì…ë ¥
    
    ![Untitled](assets/Untitled%2036.png)
    

### ë°°í¬ ì¤€ë¹„ - Mattermost

1. Jenkinsì— `Mattermost Notification Plugin` ì„¤ì¹˜
2. Jenkins ê´€ë¦¬ > System > Global Mattermost Notifier Settings
    
    ![Untitled](assets/Untitled%2037.png)
    
    Endpoint : [Mattermost ì›¹í›… URL](https://www.notion.so/CI-CD-8ab377b9a8c847f7ab1db923a768b51c?pvs=21)
    
    Channel : ì±„ë„ ì´ë¦„
    
    - íŠ¹ìˆ˜ë¬¸ìê°€ ìˆëŠ” ê²½ìš° ì•ˆ ë  ìˆ˜ë„ ìˆëŠ”ë°, í™•ì‹¤í•œ ë°©ë²•ì€ ì±„ë„ URLì„ ì ëŠ” ê²ƒì´ë‹¤.
        
        ![Untitled](assets/Untitled%2038.png)
        

### Pipeline ì‘ì„±

ğŸ’¡ **ì‹œë‚˜ë¦¬ì˜¤**

gitlab `be-develop` branchì— push

â†’ jenkinsê°€ webhookìœ¼ë¡œ ì¸í•´ ë°œë™ë¨

â†’ íŒŒì´í”„ë¼ì¸ ì‘ë™

1. **Clone Repository**
2. **Copy application.yml**
    - jenkinsì— ë”°ë¡œ ì˜¬ë ¤ë†“ì€ `application.yml` íŒŒì¼ì„ í”„ë¡œì íŠ¸ ì•ˆìœ¼ë¡œ ë³µì‚¬
3. **Build**
    - Gradleì„ ì‚¬ìš©í•˜ì—¬ `Jar` íŒŒì¼ë¡œ ë¹Œë“œ
4. **Deploy**
    1. `spring` container ì¢…ë£Œ
    2. container ë° image ì‚­ì œ
    3. ìƒˆë¡œìš´ image ìƒì„± í›„ containerë¡œ ë„ìš°ê¸°
5. **Send Mattermost Notification**

---

- Reference
    
    [[Spring] ìŠ¤í”„ë§ë¶€íŠ¸ ì  í‚¨ìŠ¤ + ë„ì»¤ë¡œ ë°°í¬í•˜ê¸°](https://learnote-dev.com/java/Spring-ì  í‚¨ìŠ¤-ë°°í¬/)
    
    [Jenkinsë¡œ Gitlab CI/CD êµ¬ì¶•í•˜ê¸°(Spring + MySQL + JenKins + Redis + Nginx)](https://junuuu.tistory.com/443)

- `Pipeline: Stage View` í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
    
    ë¹Œë“œ ê²°ê³¼ë¥¼ ì‹œê°í™”í•˜ì—¬ ë³¼ ìˆ˜ ìˆë‹¤.
    
    ![Untitled](assets/Untitled%2039.png)
    
- relicking Item > êµ¬ì„± > Pipeline ì‘ì„±
    
    ```bash
    pipeline {
        agent any
        
        tools {
            gradle "gradle_8.7"
        }
        
        stages {
            stage('Clone Repository') {
                steps {
                    echo '---------- Clone Repository ----------'
                }
            }
            
            stage('Build') {
                steps {
                    echo '---------- Build ----------'
                }
            }
            
            stage('Deploy') {
                steps {
                    echo '---------- Deploy ----------'
                }
            }
        }
    }
    ```
    

ì´ì œ ê° stage ë³„ë¡œ ì½”ë“œë¥¼ ì±„ì›Œë³´ì

1. **Clone Repository**
    
    > jenkinsì—ì„œ gitlabì„ clone
    > 
    
    ```bash
    stage('Clone Repository') {
        steps {
            echo '---------- Clone Repository ----------'
            script {
                git branch: 'be-develop',
                credentialsId: 'inhwa_gitlab_username_password',
                url: 'https://lab.ssafy.com/s10-final/S10P31D211.git'
            }
        }
    }
    ```
    
    Pipeline Syntax í™œìš©
    
    ![Untitled](assets/Untitled%2040.png)
    
    ![Untitled](assets/Untitled%2041.png)
    
    ì´ë•Œ, Credentialsì€ 2ê°€ì§€ ì¤‘ í•˜ë‚˜ì´ì–´ì•¼ í•œë‹¤.
    
    ![Untitled](assets/Untitled%2042.png)
    
    1. private key
        - git repositoryì— ssh í”„ë¡œí† ì½œì„ í†µí•´ ì•¡ì„¸ìŠ¤í•˜ëŠ” ê²½ìš°
    2. username / password
        - git repositryì— http ë˜ëŠ” httpsë¥¼ í†µí•´ ì•¡ì„¸ìŠ¤í•˜ëŠ” ê²½ìš°
    
    2ë²ˆì˜ ê²½ìš°ëŒ€ë¡œ Credentialsë¥¼ ìƒˆë¡œ ì¶”ê°€í•´ì£¼ì—ˆë‹¤.
    
2. **Copy application.yml**
    
    > jenkinsì— ë”°ë¡œ ì˜¬ë ¤ë†“ì€ `application.yml` íŒŒì¼ì„ í”„ë¡œì íŠ¸ ì•ˆìœ¼ë¡œ ë³µì‚¬
    > 
    
    ```bash
    stage('Copy application.yml') {
        steps {
            echo '---------- Copy application.yml ----------'
            withCredentials([file(credentialsId: 'application_yml', variable: 'appication_yml')]) {
                script {
                    sh 'cp $appication_yml ./backend/RelicKing/src/main/resources/application.yml'
                }
            }
        }
    }
    ```
    
    â€» resources ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ì•ˆ ë˜ë¯€ë¡œ í•´ë‹¹ ê²½ë¡œì— `.gitkeep`ì„ ë‘ì—ˆë‹¤.
    
3. **Build**
    
    > Gradleì„ ì‚¬ìš©í•˜ì—¬ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì„ JAR íŒŒì¼ë¡œ ë¹Œë“œ
    > 
    
    ```bash
    stage('Build') {
        steps {
            dir("backend/RelicKing") {
                echo '---------- Build ----------'
                sh 'chmod +x ./gradlew; ./gradlew bootJar'
            }
        }
    }
    ```
    
    `dir("backend/RelicKing")`
    
    - í•˜ìœ„ backend/RelicKingìœ¼ë¡œ ì´ë™í•˜ì—¬ ì‘ì—…
    
    `sh`
    
    - ì…¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    
    `chmod +x ./gradlew`
    
    - gradlew íŒŒì¼ì— ì‹¤í–‰ ê¶Œí•œ ì¶”ê°€
    
    `./gradlew bootJar`
    
    - Gradleì„ ì‚¬ìš©í•˜ì—¬ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹Œë“œ
    
    ë¹Œë“œê°€ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ë©´ 
    
    jenkins ì»¨í…Œì´ë„ˆì˜ `/var/jenkins_home/workspace/relicking/backend/RelicKing/build/libs` ê²½ë¡œì— JAR íŒŒì¼ì´ ìƒì„±ëœë‹¤.
    
    host PCì—ì„œëŠ” `/home/ubuntu/jenkins-data/workspace/relicking/backend/RelicKing/build/libs` ê²½ë¡œì— ë§ˆìš´íŠ¸ëœë‹¤.
    
    ---
    
    - Reference
        
        [[ìš°ì  êµ¬2í¸] ì  í‚¨ìŠ¤ íŒŒì´í”„ë¼ì¸ì„ í™œìš©í•œ ë°°í¬ ìë™í™”](https://velog.io/@sihyung92/ìš°ì  êµ¬2í¸-ì  í‚¨ìŠ¤-íŒŒì´í”„ë¼ì¸ì„-í™œìš©í•œ-ë°°í¬-ìë™í™”)
        
    
4. **Deploy**
    
    > hostì— SSH ì ‘ì†í•˜ì—¬ `deploy.sh` ì‹¤í–‰
    > 
    > - ë“±ë¡í•´ë‘ì—ˆë˜ Credentialsë¡œ ì¸ì¦
    
    ```bash
    stage('Deploy') {
        steps {
            echo '---------- Deploy ----------'
            sshagent(['k10d211.p.ssafy.io']) {
                sh 'ssh ubuntu@k10d211.p.ssafy.io "sh ~/spring/deploy.sh"'
            }
        }
    }
    ```
    
    Pipeline Syntax í™œìš©
    
    ![Untitled](assets/Untitled%2040.png)
    
    ![Untitled](assets/Untitled%2043.png)
    
5. **Send Mattermost Notification**
    
    > ë¹Œë“œ ê²°ê³¼ì— ë”°ë¼ Mattermostì— ì•Œë¦¼ ì „ì†¡
    > 
    
    ```bash
    pipeline {
    
        ...
    
        stages {
            stage('Clone Repository') {
                steps {
                    ...
                }
                post {
                    failure {
                        mattermostSend color: "danger", message: ":jenkins6:  [BE] Clone Repository ì‹¤íŒ¨.. - [Jenkins #${env.BUILD_NUMBER}](${env.BUILD_URL})"
                    }
                }
            }
            
            stage('Copy application.yml') {
                steps {
                    ...
                }
                post {
                    failure {
                        mattermostSend color: "danger", message: ":jenkins6:  [BE] Copy application.yml ì‹¤íŒ¨.. - [Jenkins #${env.BUILD_NUMBER}](${env.BUILD_URL})"
                    }
                }
            }
            
            stage('Build') {
                steps {
                    ...
                }
                post {
                    failure {
                        mattermostSend color: "danger", message: ":jenkins6:  [BE] Build ì‹¤íŒ¨.. - [Jenkins #${env.BUILD_NUMBER}](${env.BUILD_URL})"
                    }
                }
            }
            
            stage('Deploy') {
                steps {
                    ...
                }
                post {
                    failure {
                        mattermostSend color: "danger", message: ":jenkins6:  [BE] Deploy ì‹¤íŒ¨.. - [Jenkins #${env.BUILD_NUMBER}](${env.BUILD_URL})"
                    }
                }
            }
        }
        
        post {
            success {
                mattermostSend color: "good", message: ":jenkins_cute_flip:  [BE] ë°°í¬ ì„±ê³µ!! - [Jenkins #${env.BUILD_NUMBER}](${env.BUILD_URL})"
            }
        }
    }
    ```

    ğŸ’¡ **ì£¼ì˜ì‚¬í•­**
    
    ë¬¸ìì—´ì„ `"`ê°€ ì•„ë‹Œ `'`ë¡œ ê°ì‹¸ë©´ `${env.BUILD_NUMBER}`ê°™ì€ ë³€ìˆ˜ë¥¼ ì¸ì‹í•˜ì§€ ëª» í•œë‹¤!!    
    
    Pipeline Syntax í™œìš©
    
    ![Untitled](assets/Untitled%2044.png)
    

### GitLab Webhook ì„¤ì •

1. GitLab Project > Settings > Webhooks > Add new webhook
    
    ![Untitled](assets/Untitled%2045.png)
    
    URLê³¼ TriggerëŠ” [Jenkins Itemì˜ Build Triggers ì„¤ì •](https://www.notion.so/CI-CD-8ab377b9a8c847f7ab1db923a768b51c?pvs=21)ì— ìˆëŠ” ê°’ ê¸°ì…
    
2. í…ŒìŠ¤íŠ¸
    
    GitLabì—ì„œ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.
    
    ![Untitled](assets/Untitled%2046.png)
    
    Jenkinsì—ì„œ ë¹Œë“œë˜ëŠ” ê²ƒ í™•ì¸
    
    ![Untitled](assets/Untitled%2047.png)
    

### http ì ‘ê·¼ ì°¨ë‹¨

1. `spring` container down
    
    ```bash
    docker compose down spring
    ```
    
2. `docker-compose.yml` ìˆ˜ì •
    
    ports ì£¼ì„ ì²˜ë¦¬
    
    ```yaml
    services:
      
      ...
      
      spring:
        build:
          context: ./jenkins-data/workspace/relicking/backend/RelicKing
        container_name: spring
        # ports:
        #   - "8081:8081"
    
      ...
    ```
    
3. `spring` container up
    
    ```bash
    sudo docker compose up spring -d
    ```
    

[Before]

![Untitled](assets/Untitled%2048.png)

[After] `http`ë¡œëŠ” ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•˜ê³  `https`ë¡œëŠ” ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤.

![Untitled](assets/Untitled%2049.png)

![Untitled](assets/Untitled%2050.png)

![Untitled](assets/Untitled%2051.png)

## SonarQube

### SonarQube ì„¤ì¹˜

1. TCP í¬íŠ¸ 9000 í—ˆìš©
    
    ```bash
    sudo ufw allow 9000/tcp
    sudo ufw reload
    sudo ufw status  # í™•ì¸
    ```
    
2. `docker-compose.yml` ìˆ˜ì •
    
    ```yaml
    services:
      
      ...
    
      sonarqube:
        image: sonarqube:community
        hostname: sonarqube
        container_name: sonarqube
        depends_on:
          sonarqube_db:
            condition: service_healthy
        environment:
          SONAR_JDBC_URL: jdbc:postgresql://sonarqube_db:5432/sonar
          SONAR_JDBC_USERNAME: sonar
          SONAR_JDBC_PASSWORD: sonar
        volumes:
          - /home/ubuntu/sonarqube/data:/opt/sonarqube/data
          - /home/ubuntu/sonarqube/extensions:/opt/sonarqube/extensions
          - /home/ubuntu/sonarqube/logs:/opt/sonarqube/logs
        ports:
          - "9000:9000"
      
      sonarqube_db:
        image: postgres:15
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U sonar"]
          interval: 10s
          timeout: 5s
          retries: 5
        hostname: postgresql
        container_name: sonarqube_db
        environment:
          POSTGRES_USER: sonar
          POSTGRES_PASSWORD: sonar
          POSTGRES_DB: sonar
        volumes:
          - /home/ubuntu/postgresql:/var/lib/postgresql
          - /home/ubuntu/postgresql/data:/var/lib/postgresql/data
    ```
    
    sonarqube ê³µì‹ docker compose íŒŒì¼ ì°¸ê³ í•˜ì—¬ ì‘ì„±
    
    [docker-sonarqube/example-compose-files/sq-with-postgres/docker-compose.yml at master Â· SonarSource/docker-sonarqube](https://github.com/SonarSource/docker-sonarqube/blob/master/example-compose-files/sq-with-postgres/docker-compose.yml)
    
3. `vm.max_map_count` ê°’ ì„ì‹œ ìˆ˜ì • (ì¬ë¶€íŒ…í•˜ë©´ ì ìš© ì•ˆ ë¨)
    
    ```bash
    sudo sysctl -w vm.max_map_count=262144
    ```
    
4. container êµ¬ë™
    
    ```bash
    sudo docker compose up sonarqube sonarqube_db -d
    ```
    
    - ì—ëŸ¬
        
        ```bash
        ERROR Unable to create file /opt/sonarqube/logs/es.log java.io.IOException: Permission denied
        ```
        
        `/opt/sonarqube/*`ì™€ volumesë¡œ ì´ì–´ì ¸ìˆëŠ” ë””ë ‰í† ë¦¬ì˜ ê¶Œí•œ ë³€ê²½
        
        ```bash
        sudo chmod 777 /home/ubuntu/sonarqube/*
        ```
        
5. `9000` í¬íŠ¸ë¡œ ì ‘ì†
    
    ID : `admin`
    
    PW : `admin`
    
6. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
    

### SonarQube â†” Jenkins ì—°ë™

1. SonarQube í† í° ë°œê¸‰
    
    My Account > Security > Generate Tokens
    
    ![Untitled](assets/Untitled%2052.png)
    
2. í”„ë¡œì íŠ¸ ìƒì„±
    
    Create a local project
    
    ![Untitled](assets/Untitled%2053.png)
    
    ![Untitled](assets/Untitled%2054.png)
    
3. Jenkinsì—ì„œ `SonarQube Scanner`, `gradle` í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
4. Jenkins ê´€ë¦¬ > Tools > SonarQube Scanner installations
    
    Add SonarQube Scanner
    
    ![Untitled](assets/Untitled%2055.png)
    
    Save
    
5. Jenkins ê´€ë¦¬ > Credentials > (global) > Add Credentials
    
    Secret : [SonarQube í† í°](https://www.notion.so/CI-CD-8ab377b9a8c847f7ab1db923a768b51c?pvs=21)
    
    ![Untitled](assets/Untitled%2056.png)
    
6. Jenkins ê´€ë¦¬ > System > SonarQube servers
    
    Add SonarQube
    
    ![Untitled](assets/Untitled%2057.png)
    
7. [Jenkins JDK, Gradle ì„¤ì •](https://www.notion.so/Jenkins-JDK-Gradle-ebb4d5b3c26b46d6a58b1e85d7c5f7c7?pvs=21) 
8. Pipeline ìˆ˜ì •
    
    ```bash
    pipeline {
        
        ...
        
        stages {
            
            ...
            
            stage('SonarQube Analysis') {
                steps {
                    echo '---------- SonarQube Analysis ----------'
                    withSonarQubeEnv('sonarqube_server') {
                        dir("backend/RelicKing") {
                            sh 'chmod +x ./gradlew; ./gradlew sonar'
                        }
                    }
                }
                post {
                    failure {
                        mattermostSend color: "danger", message: ":jenkins6:  [BE] SonarQube Analysis ì‹¤íŒ¨.. - [Jenkins #${env.BUILD_NUMBER}](${env.BUILD_URL})"
                    }
                }
            }
            
            ...
            
        }
        
        ...
        
    }
    ```
    
9. `build.gradle` ìˆ˜ì •
    
    ```bash
    plugins {
    
    	...
    	
    	id "org.sonarqube" version "5.0.0.4638"
    }
    
    sonar {
    	properties {
    		property "sonar.projectKey", "relicking"
    		property "sonar.projectName", "relicking"
    	}
    }
    ```
    
10. ê²°ê³¼ í™•ì¸
    
    ![Untitled](assets/Untitled%2058.png)